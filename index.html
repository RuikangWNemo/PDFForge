<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>ä¸“ä¸šPDFå¤„ç†å·¥å…· - ç»ˆææ•´åˆ + æ–°åŠŸèƒ½</title>
  <style>
    :root {
      --primary: #6366f1;       /* ä¸»è‰² */
      --background: #f8fafc;    /* èƒŒæ™¯ */
      --success: #22c55e;
      --error: #ef4444;
      --card-bg: #ffffff;
      --border-color: #cbd5e1;

      --reorder-button-bg: #ff9800; /* ä¸€é”®é‡æ’æŒ‰é’®æ ·å¼ */
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--background);
      margin: 0;
      min-height: 100vh;
    }

    /*
     * ä¸‰åˆ—å¸ƒå±€ï¼š
     * å·¦ä¾§(æ§åˆ¶é¢æ¿) 320px, ä¸­é—´(é¢„è§ˆPDFé¡µé¢) 1fr, å³ä¾§(åˆå¹¶é¢„è§ˆ) 400px
     */
    .main-container {
      max-width: 1600px;
      margin: 2rem auto;
      display: grid;
      grid-template-columns: 320px 1fr 400px;
      gap: 2rem;
      padding: 0 1rem;
    }

    /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* ä¸Šä¼ åŒºåŸŸ */
    .upload-area {
      background: var(--card-bg);
      border: 2px dashed var(--border-color);
      border-radius: 1rem;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      text-align: center;
    }
    .upload-area:hover {
      border-color: var(--primary);
      background: #f1f5f9;
    }
    .upload-area span {
      color: #64748b;
      margin-bottom: 0.5rem;
    }

    /* è¿›åº¦æ¡ */
    .progress-container {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 4px;
      background: #e2e8f0;
      overflow: hidden;
      border-radius: 0 0 1rem 1rem;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background: var(--primary);
      transition: width 0.3s ease;
    }

    /* é¢œè‰²ç®¡ç† */
    .color-palette {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px,1fr));
      gap: 0.5rem;
      max-height: 140px;
      overflow-y: auto;
      padding: 0.5rem;
      background: var(--card-bg);
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .color-add-btn {
      background: #f1f5f9;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      cursor: pointer;
      height: 40px;
    }
    .color-add-btn:hover {
      background: #e2e8f0;
    }
    .color-item {
      width: 100%; height: 40px;
      border-radius: 0.25rem;
      position: relative;
      cursor: pointer;
    }
    .color-delete {
      position: absolute;
      top: -8px; right: -8px;
      width: 20px; height: 20px;
      background: var(--error);
      color: #fff;
      border-radius: 50%;
      font-size: 14px;
      text-align: center;
      line-height: 20px;
      display: none;
      cursor: pointer;
    }
    .color-item:hover .color-delete {
      display: block;
    }

    /* æ©¡çš®æ“¦ & æŸ¥çœ‹é¢„è§ˆ */
    .eraser-toggle {
      display: inline-block;
      padding: 0.4rem 0.8rem;
      border-radius: 0.5rem;
      cursor: pointer;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #cbd5e1;
      transition: all 0.2s;
      margin-bottom: 0.5rem;
    }
    .eraser-toggle.active {
      background: #f87171; /* æ©¡çš®æ¨¡å¼å¯ç”¨æ—¶ç»™ä¸ªæ˜æ˜¾çš„é¢œè‰² */
      color: #fff;
      border-color: #dc2626;
    }
    .preview-toggle {
      display: inline-block;
      padding: 0.4rem 0.8rem;
      border-radius: 0.5rem;
      cursor: pointer;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #cbd5e1;
      transition: all 0.2s;
    }
    .preview-toggle.active {
      background: #4ade80;
      color: #fff;
      border-color: #22c55e;
    }

    /* å¯¼å‡ºè®¾ç½® */
    .advanced-settings {
      background: var(--card-bg);
      border-radius: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      padding: 1rem;
    }
    .export-presets {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .preset-btn {
      background: #f1f5f9;
      border: none;
      padding: 0.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .preset-btn:hover {
      background: #e2e8f0;
    }
    .format-controls {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .format-controls label, .format-controls select {
      font-size: 0.9rem;
      color: #475569;
    }
    .export-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--primary);
      border: none;
      border-radius: 0.5rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1rem;
    }
    .export-btn:hover {
      background: #4f46e5;
    }

    /* ä¸­é—´PDF(åŠå›¾ç‰‡)é¢„è§ˆ */
    .preview-canvas {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
      overflow-y: auto;
      position: relative;
      height: 85vh;
      padding: 1rem;
    }
    .page-container {
      position: relative;
      margin: 0 auto 1rem auto;
      transition: transform 0.2s;
      border-bottom: 1px solid #e2e8f0;
      border: 2px solid transparent;
      border-radius: 0.5rem;
      padding: 0.5rem 0;

      /* æ‹–æ‹½ */
      cursor: move;
    }
    .page-container:hover {
      background: #f9fafb;
    }
    .page-container canvas, 
    .page-container img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
    }

    /* å°çš„â€œç¬¬Xé¡µâ€æ ‡ç­¾ï¼ˆä¸å¯é€‰ä¸­ï¼‰ */
    .page-label {
      position: absolute;
      top: 8px; left: 8px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
      user-select: none;
    }

    /* å³ä¾§åˆå¹¶é¢„è§ˆ & åˆ†ç»„ç®¡ç† */
    .merged-preview {
      background: var(--card-bg);
      border-radius: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      height: 85vh;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .group-preview {
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .group-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: move; /* æç¤ºå¯æ‹–æ‹½åˆ†ç»„ */
    }
    .group-color-box {
      width: 20px; height: 20px;
      border-radius: 0.25rem;
    }
    .group-title-input {
      flex: 1; 
      border: 1px solid #ccc;
      border-radius: 0.25rem;
      padding: 0.2rem 0.5rem;
      font-size: 0.85rem;
    }
    .group-remove-btn {
      position: absolute;
      top: 0.5rem; right: 0.5rem;
      background: var(--error);
      color: #fff;
      border: none;
      border-radius: 0.25rem;
      width: 24px; height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 22px;
      text-align: center;
    }
    .group-fullscreen-btn {
      background: #4ade80;
      border: none;
      border-radius: 0.25rem;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      font-size: 0.75rem;
      color: #fff;
      margin-left: auto;
      margin-right: 2.5rem; /* é¢„ç•™ç©ºé—´ç»™åˆ é™¤æŒ‰é’® */
    }
    .group-fullscreen-btn:hover {
      background: #22c55e;
    }
    .group-merged-preview-img {
      max-width: 100%;
      max-height: 100px;
      display: block;
      border: 1px solid #ddd;
      margin-bottom: 0.5rem;
    }
    .group-pages {
      font-size: 0.85rem;
      color: #475569;
      margin-bottom: 0.5rem;
    }
    .preview-scroll {
      overflow-x: auto;
      max-width: 100%;
      white-space: nowrap;
    }
    .preview-scroll img {
      max-height: 150px;
      display: inline-block;
      margin-right: 0.5rem;
    }

    /* Toastï¼šæ”¯æŒè‡ªåŠ¨éšè—åŠ¨ç”» */
    .toast {
      position: fixed;
      top: 1rem; right: 1rem;
      background: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: none;
      z-index: 9999;
      width: 250px;
      border-left: 6px solid transparent; /* åŠ¨æ€èµ‹è‰² */
      transition: transform 0.4s ease-in-out, opacity 0.4s ease;
      transform: translateX(0);
    }
    .toast.show {
      display: block;
    }
    .toast.slide-out {
      transform: translateX(120%);
      opacity: 0;
    }
    .toast-message {
      margin: 0;
      font-size: 0.875rem;
      color: #475569;
    }

    /* é¼ æ ‡é«˜äº®(é¢œè‰²ç‚¹/æ©¡çš®) */
    .cursor-highlight {
      position: fixed;
      width: 16px; height: 16px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      mix-blend-mode: difference;
      display: none;
    }

    /* æ‹–æ‹½æ ·å¼ */
    .droptarget-hover {
      outline: 2px dashed #22c55e;
    }
    .dragging {
      opacity: 0.6;
    }

    /* å°ç¼©ç•¥å›¾(åˆ†ç»„é‡Œ) */
    .page-thumb {
      display: inline-block;
      margin-right: 0.5rem;
      position: relative;
      cursor: move;
    }
    .page-thumb.dragging {
      opacity: 0.5;
      border: 2px dashed #444;
    }

    /* æ–°å¢ï¼šä¸€é”®é‡æ’ + æ¸…ç©ºåˆ†ç»„æŒ‰é’® */
    .reorder-btn {
      padding: 0.5rem 1rem;
      background: var(--reorder-button-bg);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    .reorder-btn:hover {
      background: #fb8c00;
    }
    .clear-groups-btn {
      padding: 0.5rem 1rem;
      background: #dc2626;
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }
    .clear-groups-btn:hover {
      background: #b91c1c;
    }

    /* å…¨å±é¢„è§ˆæ¨¡æ€çª— (åˆ†ç»„é¢„è§ˆ) */
    .fullscreen-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99999;
      display: none; /* åˆå§‹éšè— */
      justify-content: center;
      align-items: center;
    }
    .fullscreen-modal.active {
      display: flex;
    }
    .fullscreen-content {
      width: 90%;
      height: 90%;
      background: #fff;
      border-radius: 0.5rem;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1rem;
      position: relative;
      overflow: hidden;
    }
    .fullscreen-left {
      background: #f9fafb;
      padding: 1rem;
      overflow-y: auto;
    }
    .fullscreen-right {
      background: #ffffff;
      padding: 1rem;
      overflow-y: auto;
      position: relative;
    }
    .fullscreen-close-btn {
      position: absolute; top: 1rem; right: 1rem;
      background: var(--error);
      color: #fff;
      border: none;
      border-radius: 0.25rem;
      width: 32px; height: 32px;
      cursor: pointer;
      font-size: 20px;
      line-height: 30px;
      text-align: center;
      z-index: 999999;
    }
    .fullscreen-title {
      margin: 0 0 1rem 0;
      font-size: 1.2rem;
      font-weight: 600;
    }
    .fullscreen-left .page-item {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 0.25rem;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: move;
    }
    .page-item:hover {
      background: #f1f5f9;
    }
    .page-item img {
      max-width: 50px;
      max-height: 70px;
    }
    .delete-page-btn {
      margin-left: auto;
      background: var(--error);
      color: #fff;
      border: none;
      border-radius: 0.25rem;
      width: 24px; height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 22px;
      text-align: center;
    }
    .preview-large-img {
      max-width: 100%;
      border: 1px solid #e5e7eb;
      margin-bottom: 1rem;
      display: block;
    }
    .fs-actions {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .fs-button {
      background: #93c5fd;
      color: #fff;
      border: none;
      border-radius: 0.25rem;
      padding: 0.3rem 0.6rem;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .fs-button:hover {
      background: #60a5fa;
    }

    /* æ–°å¢ï¼šæŸ¥çœ‹å¤§å›¾æ¨¡å¼ */
    .image-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 999999;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .image-modal.active {
      display: flex;
    }
    .image-modal-content {
      position: relative;
      background: #fff;
      max-width: 80%;
      max-height: 80%;
      border-radius: 0.5rem;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }
    .image-modal-close {
      position: absolute;
      top: 1rem; right: 1rem;
      background: var(--error);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px; height: 32px;
      cursor: pointer;
      font-size: 20px;
      line-height: 30px;
      text-align: center;
    }
    .image-modal-img {
      max-width: 100%;
      max-height: calc(100% - 80px);
      margin: auto;
      display: block;
      border: 1px solid #ccc;
    }
    .image-modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
    }
    .image-modal-nav button {
      pointer-events: auto;
      background: rgba(0,0,0,0.5);
      color: #fff;
      border: none;
      width: 40px; height: 40px;
      font-size: 18px;
      border-radius: 0.25rem;
      cursor: pointer;
    }
  </style>
</head>

<body>
<!-- è‡ªå®šä¹‰é¼ æ ‡å…‰æ ‡(é¢œè‰²ç‚¹/æ©¡çš®æ¨¡å¼) -->
<div id="cursorDot" class="cursor-highlight"></div>

<div class="main-container">
  <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
  <div class="control-panel">
    <!-- 1. ä¸Šä¼ PDFåŒºåŸŸ -->
    <div class="upload-area" id="dropZone" 
        ondragover="event.preventDefault()" 
        ondrop="handleFileDrop(event)">
    <span>ğŸ“ æ‹–æ‹½æˆ–ç‚¹å‡»é€‰æ‹© PDF æˆ–å›¾ç‰‡</span>
    <input type="file" id="fileInput" accept="application/pdf,image/jpeg,image/png" multiple hidden>
    <div class="progress-container">
    <div class="progress-bar" id="globalProgress"></div>
    </div>
    </div>

    <!-- 2. é¢œè‰²ç®¡ç† -->
    <div class="color-palette" id="colorPalette">
      <div class="color-add-btn" onclick="showColorPicker()">+</div>
      <!-- é»˜è®¤é¢œè‰²ç”±JSåˆå§‹åŒ– -->
    </div>

    <!-- æ©¡çš®æ“¦ & æŸ¥çœ‹é¢„è§ˆ -->
    <button id="eraserBtn" class="eraser-toggle" onclick="toggleEraserMode()">
      æ©¡çš®åŠŸèƒ½ï¼šå…³é—­
    </button>
    <button id="viewBtn" class="preview-toggle" onclick="toggleViewMode()">
      æŸ¥çœ‹é¢„è§ˆï¼šå…³é—­
    </button>

    <!-- 3. å¯¼å‡ºè®¾ç½® -->
    <div class="advanced-settings" id="exportSettingsArea">
      <div class="export-presets">
        <button class="preset-btn" onclick="applyPreset('web')">ç½‘é¡µä½¿ç”¨ (72dpi)</button>
        <button class="preset-btn" onclick="applyPreset('print')">å°åˆ·è´¨é‡ (300dpi)</button>
      </div>

      <div class="format-controls">
        <label>è¾“å‡ºæ ¼å¼ï¼š
          <select id="exportFormat" onchange="updateFormatOptions()">
            <option value="png">PNG</option>
            <option value="jpg">JPEG</option>
            <option value="pdf-single">PDF(å•æ–‡ä»¶)</option>
            <option value="pdf-multi">PDF(å¤šæ–‡ä»¶)</option>
          </select>
        </label>
        <div id="imageOptions">
          <label>å›¾åƒè´¨é‡ï¼š<span id="qualityValue">100</span>%
            <input type="range" min="50" max="100" value="100"
                   oninput="updateQuality(this.value)">
          </label>
          <label>åˆ†è¾¨ç‡ï¼š
            <select id="dpiSelect">
              <option value="72">72 DPI</option>
              <option value="150">150 DPI</option>
              <option value="300" selected>300 DPI</option>
            </select>
          </label>
        </div>
        <div id="pdfOptions" style="display:none">
          <label>
            <input type="checkbox" id="compressPDF" checked> å¯ç”¨å‹ç¼©(ç¤ºæ„)
          </label>
          <label>PDFç‰ˆæœ¬ï¼š
            <select id="pdfVersion">
              <option value="1.7">1.7 (è¾ƒæ–°)</option>
              <option value="1.4">1.4 (æ›´å…¼å®¹)</option>
            </select>
          </label>
        </div>
      </div>

      <button class="export-btn" onclick="startExport()">ğŸš€ å¼€å§‹å¯¼å‡º</button>
    </div>
  </div>

  <!-- ä¸­é—´ PDF/å›¾ç‰‡ é¢„è§ˆåŒº -->
  <div class="preview-canvas" id="previewArea"></div>

  <!-- å³ä¾§åˆå¹¶é¢„è§ˆ & åˆ†ç»„ç®¡ç† -->
  <div class="merged-preview" id="mergedPreviewArea">
    <h3 style="margin-top:0;">åˆå¹¶é¢„è§ˆ & åˆ†ç»„ç®¡ç†</h3>
    <p style="font-size:0.85rem;color:#475569;">
      æ‹–æ‹½åˆ†ç»„æˆ–é¡µé¢æ’åºï¼›<br/>
      â€œå…¨å±é¢„è§ˆâ€å¯å†æ¬¡æ’åº/åˆ é™¤é¡µé¢ï¼›<br/>
      â€œä¸€é”®é‡æ’â€å¿«é€Ÿç¼–å·ï¼›â€œæ¸…ç©ºåˆ†ç»„â€ä¼šæ¸…é™¤æ‰€æœ‰æ ‡è®°ã€‚
    </p>
    <div style="display:flex; gap:0.5rem; margin-bottom:0.5rem;">
      <button class="reorder-btn" onclick="reorderGroupNames()">ä¸€é”®é‡æ’ç¼–å·</button>
      <button class="clear-groups-btn" onclick="clearAllGroups()">æ¸…ç©ºåˆ†ç»„</button>
    </div>
    <!-- åŠ¨æ€ç”Ÿæˆ group-preview -->
  </div>
</div>

<!-- Toast æç¤º -->
<div id="toast" class="toast">
  <p class="toast-message" id="toastMessage"></p>
</div>

<!-- å…¨å±é¢„è§ˆå¼¹çª—(åˆ†ç»„) -->
<div id="fullscreenModal" class="fullscreen-modal">
  <div class="fullscreen-content">
    <button class="fullscreen-close-btn" onclick="closeFullscreenModal()">Ã—</button>
    <div class="fullscreen-left" id="fsLeftPanel">
      <h4 class="fullscreen-title" id="fsLeftTitle"></h4>
      <div class="fs-actions">
        <button class="fs-button" onclick="sortFsPagesByNumber()">æŒ‰é¡µç é¡ºåº</button>
        <button class="fs-button" onclick="saveFsPageOrder()">ä¿å­˜å½“å‰é¡ºåº</button>
      </div>
      <!-- page-itemåˆ—è¡¨ -->
    </div>
    <div class="fullscreen-right">
      <h4 class="fullscreen-title" id="fsRightTitle">åˆå¹¶é¢„è§ˆ</h4>
      <div id="fsPreviewImgs"></div>
    </div>
  </div>
</div>

<!-- æŸ¥çœ‹å¤§å›¾(ç‚¹å‡»é¡µé¢æˆ–ç¼©ç•¥å›¾æ—¶,è‹¥â€œæŸ¥çœ‹é¢„è§ˆâ€æ¨¡å¼å¯ç”¨) -->
<div id="imageModal" class="image-modal">
  <div class="image-modal-content">
    <button class="image-modal-close" onclick="closeImageModal()">Ã—</button>
    <img id="imageModalImg" class="image-modal-img" src="" alt="å¤§å›¾é¢„è§ˆ"/>
    <div class="image-modal-nav">
      <button id="imageModalPrev" onclick="gotoModalPrevPage()">â†</button>
      <button id="imageModalNext" onclick="gotoModalNextPage()">â†’</button>
    </div>
  </div>
</div>

<!-- å¼•å…¥ PDF.js & PDF-lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
/* ===============================================
 * å…¨å±€çŠ¶æ€
 * ===============================================*/
let appState = {
  // PDF doc
  pdfDoc: null,
  totalPages: 0,

  // è®°å½•æ¯ä¸€é¡µçš„é¢œè‰²(å¤šè‰²)
  // å¯¹äºâ€œå›¾ç‰‡åºåˆ—â€ï¼Œå¯å°†å®ƒä»¬ä¹Ÿè§†ä½œâ€œpageâ€ï¼Œç¼–å·æ¥åœ¨pdfåé¢ï¼Ÿ
  // æˆ–å¦å­˜æ•°ç»„ï¼Ÿæ­¤å¤„æ¼”ç¤ºå°†å®ƒä»¬ç»Ÿä¸€æ”¾åœ¨ mainPageOrder é‡Œã€‚
  pageColors: {},  // key=pageId, value=Set(colors)

  // ä¸»è¦é¢„è§ˆçš„é¡µé¢é¡ºåº(æ—¢åŒ…å«pdfPage1..N,ä¹Ÿå¯èƒ½åŒ…å«imgPage1..M)
  // element like {type:'pdf', pageNum:1} or {type:'img', id:'img_003'}
  mainPageOrder: [],

  // å½“å‰é¢œè‰²
  currentColor: '#fecaca',

  // æ©¡çš® & é¢„è§ˆæ¨¡å¼
  eraserMode: false,
  viewMode: false, // trueè¡¨ç¤ºâ€œæŸ¥çœ‹é¢„è§ˆâ€åŠŸèƒ½å¼€å¯

  // SHIFT è¿é€‰
  lastClickedPage: null,

  // åˆ†ç»„åç§° & é¡ºåº
  groupNames: {},   // color->string
  groupOrder: [],   // coloræ•°ç»„

  // ä¸ºäº†æ”¯æŒâ€œåœ¨å…¨å±é‡Œè‡ªå®šä¹‰æ’åºåï¼Œä¿å­˜åˆ°åˆå¹¶é¢„è§ˆâ€ï¼š
  // customPageOrder[color] = [pageId1, pageId2, ...]
  // pageIdå½¢å¦‚ "pdf-3" æˆ– "img-001"
  customPageOrder: {},

  // å¯¼å‡ºè®¾ç½®
  exportSettings: {
    format: 'png',
    quality: 1.0,
    dpi: 300,
    pdfVersion: '1.7',
    compress: true
  },

  // ç”¨äºå­˜å‚¨â€œå›¾ç‰‡åºåˆ—â€ => {id:'img-xxx', file:File, dataURL:String}
  imagePages: []
};

pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* ====================================================
 * 1. é€‰æ‹©PDFæ–‡ä»¶ / æ‹–æ‹½
 * ====================================================*/
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');

dropZone.addEventListener('click',()=>fileInput.click());
fileInput.onchange = handleFileSelect;

function handleFileDrop(e){
  e.preventDefault();
  let file=e.dataTransfer.files[0];
  if(file){
    fileInput.files=e.dataTransfer.files;
    handleFileSelect({target:{files:e.dataTransfer.files}});
  }
}

async function handleFileSelect(e){
  const file=e.target.files[0];
  if(!file)return;
  try{
    showLoading('æ­£åœ¨åŠ è½½PDF...');
    const fr=new FileReader();
    fr.onload=async()=>{
      const pdfData=new Uint8Array(fr.result);
      appState.pdfDoc=await pdfjsLib.getDocument({data:pdfData}).promise;
      appState.totalPages=appState.pdfDoc.numPages;
      // æ¸…ç†
      appState.pageColors={};
      appState.mainPageOrder=[];
      appState.lastClickedPage=null;
      appState.groupNames={};
      appState.groupOrder=[];
      appState.customPageOrder={};
      // æ„é€ pdfé¡µ
      for(let p=1;p<=appState.totalPages;p++){
        appState.mainPageOrder.push({type:'pdf', pageNum:p});
        appState.pageColors[`pdf-${p}`] = new Set();
      }
      // æ¸²æŸ“
      await renderMainPreview();
      hideLoading();
      showToast(`PDFåŠ è½½å®Œæˆ,å…±${appState.totalPages}é¡µ`);
      updateMergedPreview();
    };
    fr.onprogress=(ev)=>{
      if(ev.lengthComputable){
        updateProgress((ev.loaded/ev.total)*100);
      }
    };
    fr.readAsArrayBuffer(file);
  }catch(err){
    showError('åŠ è½½PDFå¤±è´¥: '+err.message);
  }
}

/* ================================================
 * 1.2 é€‰æ‹©æ–‡ä»¶å¤¹(å¯¼å…¥åºåˆ—å›¾ç‰‡)
 * ================================================*/
async function handleImageFolderSelect(e){
  const files=[...e.target.files];
  if(!files.length) return;
  // è¿‡æ»¤æ‰ä¸æ˜¯png/jpgçš„
  const imageFiles=files.filter(f=>{
    const nm=f.name.toLowerCase();
    return nm.endsWith('.png')||nm.endsWith('.jpg')||nm.endsWith('.jpeg');
  });
  if(!imageFiles.length){
    showToast('è¯¥æ–‡ä»¶å¤¹ä¸å«ä»»ä½•png/jpg','error');
    return;
  }
  showLoading('æ­£åœ¨è¯»å–å›¾ç‰‡...');
  // æŒ‰æ–‡ä»¶åè‡ªç„¶æ’åº
  imageFiles.sort((a,b)=> a.name.localeCompare(b.name,undefined,{numeric:true}));

  // é€ä¸ªè¯»å– dataURL
  let idxStart = 1 + appState.imagePages.length; // è‹¥ä¹‹å‰å·²å¯¼å…¥è¿‡
  for(let i=0;i<imageFiles.length;i++){
    let f=imageFiles[i];
    let rr=await readFileToDataURL(f);
    let id=`img-${String(idxStart+i).padStart(3,'0')}`;
    appState.imagePages.push({
      id, file:f, dataURL:rr
    });
    // åŒæ­¥ mainPageOrder & pageColors
    appState.mainPageOrder.push({type:'img', id});
    appState.pageColors[id] = new Set();
  }
  // é‡æ–°æ¸²æŸ“
  await renderMainPreview();
  hideLoading();
  showToast(`å·²å¯¼å…¥ ${imageFiles.length} å¼ å›¾ç‰‡`);
  updateMergedPreview();
}

function readFileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(fr.result);
    fr.onerror=reject;
    fr.readAsDataURL(file);
  });
}


/* ================================================
 * 2. ä¸­é—´ä¸»é¢„è§ˆ(åŒ…å«pdf pages & img pages)
 * ================================================*/
const previewArea=document.getElementById('previewArea');

async function renderMainPreview(){
  previewArea.innerHTML='';
  updateProgress(0);

  // æ‹–æ‹½äº‹ä»¶(ç”¨äºæ‹–æ‹½é‡æ’ä¸»é¡ºåº)
  previewArea.addEventListener('dragstart',mainPageDragStart);
  previewArea.addEventListener('dragend',mainPageDragEnd);
  previewArea.addEventListener('dragover',mainPageDragOver);
  previewArea.addEventListener('drop',mainPageDrop);

  // ç›‘å¬é¼ æ ‡(ä¸Šè‰²/æ©¡çš®) 
  previewArea.addEventListener('mousedown',onPreviewMouseDown);
  previewArea.addEventListener('mousemove',onPreviewMouseMove);
  previewArea.addEventListener('mouseup',onPreviewMouseUp);
  previewArea.addEventListener('mouseleave',onPreviewMouseUp);

  const total = appState.mainPageOrder.length;
  for(let i=0;i<total;i++){
    let item = appState.mainPageOrder[i];
    let container = document.createElement('div');
    container.className='page-container';
    container.draggable=true; // å…è®¸æ‹–æ‹½
    let pageId='';
    if(item.type==='pdf'){
      pageId=`pdf-${item.pageNum}`;
      container.dataset.pageid=pageId;

      const label=document.createElement('div');
      label.className='page-label';
      label.textContent=`ç¬¬ ${item.pageNum} é¡µ`;
      container.appendChild(label);

      // pdfç¦»å±æ¸²æŸ“
      const page=await appState.pdfDoc.getPage(item.pageNum);
      const scale=0.3;
      const viewport=page.getViewport({scale});
      const cv=document.createElement('canvas');
      cv.width=viewport.width; cv.height=viewport.height;
      await page.render({
        canvasContext: cv.getContext('2d'),
        viewport
      }).promise;
      container.appendChild(cv);
    } else {
      // image page
      pageId=item.id; // 'img-xxx'
      container.dataset.pageid=pageId;

      // ä¹Ÿå¯æ˜¾ç¤º label
      const label=document.createElement('div');
      label.className='page-label';
      label.textContent=`å›¾ç‰‡ ${pageId.replace('img-','')}`;
      container.appendChild(label);

      // åŠ è½½ dataURL
      let imgObj=appState.imagePages.find(x=>x.id===pageId);
      if(imgObj){
        let im=document.createElement('img');
        im.src=imgObj.dataURL;
        container.appendChild(im);
      }
    }

    // ç»™ container è¾¹æ¡†
    updatePageContainerBorder(container,pageId);

    // å¦‚æœå¤„äºâ€œæŸ¥çœ‹é¢„è§ˆâ€æ¨¡å¼, ç‚¹å‡»å¯ç›´æ¥å¼¹çª—çœ‹å¤§å›¾
    container.addEventListener('click',(evt)=>{
      if(isDragging) return; // æ­£åœ¨æ‹–æ‹½
      if(!isMouseDown) return; // ä¹Ÿå¯èƒ½ç‚¹ä¸‹
      if(appState.viewMode){
        openImageModal(pageId);
      } else {
        // å¦åˆ™åšä¸Šè‰²
        if(!isDragging){
          handlePageClick(pageId,evt);
        }
      }
    });

    previewArea.appendChild(container);
    updateProgress(((i+1)/total)*100);
  }
}

// è®°å½•æ˜¯å¦åœ¨mousedown(ç”¨äºåŒºåˆ†å•å‡» vs æ‹–æ‹½)
let isMouseDown=false;
function onPreviewMouseDown(e){
  const cont=findPageContainer(e);
  if(cont){
    isMouseDown=true;
    isDragging=true;
    handlePageClick(cont.dataset.pageid,e);
  }
}
function onPreviewMouseMove(e){
  if(!isDragging||!isMouseDown||appState.viewMode) return;
  const cont=findPageContainer(e);
  if(cont){
    handlePageClick(cont.dataset.pageid,e);
  }
}
function onPreviewMouseUp(e){
  isMouseDown=false;
  isDragging=false;
}
function findPageContainer(e){
  const el=document.elementFromPoint(e.clientX,e.clientY);
  if(!el) return null;
  if(el.classList.contains('page-container')) return el;
  if(el.parentElement?.classList.contains('page-container')) return el.parentElement;
  return null;
}

// ä¸Šè‰²/æ©¡çš®
let isDragging=false;
function handlePageClick(pageId,evt){
  const shift=evt.shiftKey;
  if(!shift){
    applyColorOne(pageId);
    appState.lastClickedPage=pageId;
  } else {
    if(appState.lastClickedPage===null){
      applyColorOne(pageId);
      appState.lastClickedPage=pageId;
    } else {
      // â€œåŒºé—´â€ä»…å¯¹pdfé¡µæœ‰æ„ä¹‰(æ•°å­—é¡ºåº)
      // è¿™é‡Œä¹Ÿå¯å°è¯•å¯¹mainPageOrderæ‰¾åˆ°è¿™2ä¸ªä½ç½®
      let list=appState.mainPageOrder.map(x=>x.type==='pdf'?`pdf-${x.pageNum}`:x.id);
      let idx1=list.indexOf(appState.lastClickedPage);
      let idx2=list.indexOf(pageId);
      if(idx1<0||idx2<0){
        applyColorOne(pageId);
        appState.lastClickedPage=pageId;
      } else {
        let start=Math.min(idx1,idx2), end=Math.max(idx1,idx2);
        for(let i=start;i<=end;i++){
          let pid=list[i];
          applyColorOne(pid);
        }
      }
    }
  }
}
function applyColorOne(pageId){
  if(!appState.pageColors[pageId]){
    appState.pageColors[pageId]=new Set();
  }
  let cset=appState.pageColors[pageId];
  if(appState.eraserMode){
    if(cset.size<=1){
      cset.clear();
      showToast(`å·²æ“¦é™¤ ${pageId} çš„é¢œè‰²`);
    } else {
      if(cset.has(appState.currentColor)){
        cset.delete(appState.currentColor);
        showToast(`å·²æ“¦é™¤ ${pageId} çš„ ${appState.currentColor}`);
      }
    }
  } else {
    cset.add(appState.currentColor);
    if(!appState.groupOrder.includes(appState.currentColor)){
      appState.groupOrder.push(appState.currentColor);
    }
  }
  const container=previewArea.querySelector(`.page-container[data-pageid='${pageId}']`);
  if(container) updatePageContainerBorder(container,pageId);
  updateMergedPreview();
}

function updatePageContainerBorder(container,pageId){
  let cset=appState.pageColors[pageId];
  if(cset&&cset.size>0){
    container.style.borderColor=[...cset][0];
  } else {
    container.style.borderColor='transparent';
  }
}

/* ================================================
 * 2.1 ä¸»é¢„è§ˆæ’åº(æ‹–æ‹½)
 * ================================================*/
let draggedMainPage=null;
function mainPageDragStart(e){
  if(e.target.classList.contains('page-container')){
    draggedMainPage=e.target;
    e.target.classList.add('dragging');
  }
}
function mainPageDragEnd(e){
  if(draggedMainPage){
    draggedMainPage.classList.remove('dragging');
  }
  draggedMainPage=null;
  // ä¿å­˜é¡ºåº
  saveMainPageOrderFromDOM();
}
function mainPageDragOver(e){
  e.preventDefault();
  let tgt=e.target;
  if(tgt.classList.contains('page-container')&&tgt!==draggedMainPage){
    tgt.classList.add('droptarget-hover');
  }
}
function mainPageDrop(e){
  e.preventDefault();
  let tgt=e.target;
  if(tgt.classList.contains('page-container')){
    tgt.classList.remove('droptarget-hover');
    if(draggedMainPage&&draggedMainPage!==tgt){
      let parent=previewArea;
      let arr=[...parent.querySelectorAll('.page-container')];
      let drI=arr.indexOf(draggedMainPage);
      let tgI=arr.indexOf(tgt);
      if(drI<tgI){
        parent.insertBefore(draggedMainPage,tgt.nextSibling);
      } else {
        parent.insertBefore(draggedMainPage,tgt);
      }
    }
  }
}
function saveMainPageOrderFromDOM(){
  let containers=[...previewArea.querySelectorAll('.page-container')];
  let newOrder=[];
  for(let c of containers){
    let pid=c.dataset.pageid; // e.g. 'pdf-3' or 'img-001'
    if(pid.startsWith('pdf-')){
      let pn=parseInt(pid.replace('pdf-',''));
      newOrder.push({type:'pdf',pageNum:pn});
    } else {
      newOrder.push({type:'img',id:pid});
    }
  }
  appState.mainPageOrder=newOrder;
}


/* ================================================
 * 3. é¢œè‰²ç³»ç»Ÿ(å¤šè‰²) + æ©¡çš®æ“¦
 * ================================================*/
const colorPalette=document.getElementById('colorPalette');
const defaultColors=['#fecaca','#bfdbfe','#bbf7d0','#fde68a','#ddd6fe','#a5f3fc'];
function initDefaultColors(){
  defaultColors.forEach(c=>addColorItem(c));
}
initDefaultColors();

function addColorItem(color){
  let existed=appState.groupOrder.some(x=>x.toLowerCase()===color.toLowerCase());
  if(!existed){
    appState.groupOrder.push(color);
  }
  const item=document.createElement('div');
  item.className='color-item';
  item.style.backgroundColor=color;

  const delBtn=document.createElement('div');
  delBtn.className='color-delete';
  delBtn.textContent='Ã—';
  delBtn.onclick=(e)=>{
    e.stopPropagation();
    if(confirm(`ç¡®å®šåˆ é™¤æ­¤é¢œè‰²(${color})ï¼Ÿ\n(ä¸ä¼šè‡ªåŠ¨æ“¦é™¤å·²æ ‡è®°é¡µé¢)`)){
      item.remove();
      let idx=appState.groupOrder.indexOf(color);
      if(idx>=0) appState.groupOrder.splice(idx,1);
    }
  };
  item.appendChild(delBtn);
  item.onclick=()=>{
    appState.currentColor=color;
    showToast(`å·²é€‰ä¸­é¢œè‰²: ${color}`,color);
    updateCursorDot();
  };

  colorPalette.prepend(item);
}

function showColorPicker(){
  const inp=document.createElement('input');
  inp.type='color';
  inp.style.display='none';
  document.body.appendChild(inp);
  inp.click();
  inp.onchange=()=>{
    addColorItem(inp.value);
    document.body.removeChild(inp);
  };
  inp.onblur=()=>{
    document.body.removeChild(inp);
  };
}

function toggleEraserMode(){
  appState.eraserMode=!appState.eraserMode;
  const btn=document.getElementById('eraserBtn');
  if(appState.eraserMode){
    btn.classList.add('active');
    btn.textContent='æ©¡çš®åŠŸèƒ½ï¼šå¼€å¯';
  } else {
    btn.classList.remove('active');
    btn.textContent='æ©¡çš®åŠŸèƒ½ï¼šå…³é—­';
  }
  updateCursorDot();
}

/* ================================================
 * 3.1 æŸ¥çœ‹é¢„è§ˆæ¨¡å¼(ç‚¹å‡»é¡µé¢/ç¼©ç•¥å›¾ -> å¤§å›¾å¼¹çª—)
 * ================================================*/
function toggleViewMode(){
  appState.viewMode=!appState.viewMode;
  const vb=document.getElementById('viewBtn');
  if(appState.viewMode){
    vb.classList.add('active');
    vb.textContent='æŸ¥çœ‹é¢„è§ˆï¼šå¼€å¯';
    showToast('ç°åœ¨ç‚¹å‡»ä»»æ„é¡µé¢/ç¼©ç•¥å›¾å°†è¿›å…¥å¤§å›¾æŸ¥çœ‹æ¨¡å¼','info');
  } else {
    vb.classList.remove('active');
    vb.textContent='æŸ¥çœ‹é¢„è§ˆï¼šå…³é—­';
  }
}

// æ‰“å¼€å¤§å›¾å¼¹çª—
let imageModal=document.getElementById('imageModal');
let imageModalImg=document.getElementById('imageModalImg');
let modalIndex=0;
let modalPageIds=[]; // å¯å·¦å³ç¿»é¡µ

function openImageModal(pageId, allList=[]){
  if(!appState.viewMode) return; // åªæœ‰åœ¨viewModeæ—¶æ‰å¯ç‚¹å¼€

  // æ„å»ºmodalPageIds
  if(allList.length){
    modalPageIds=[...allList];
  } else {
    // é»˜è®¤ï¼šæ‰€æœ‰å¯è§(ä¸­é—´é¢„è§ˆ)ï¼Ÿ
    modalPageIds=appState.mainPageOrder.map(x=>x.type==='pdf'?`pdf-${x.pageNum}`:x.id);
  }
  modalIndex=modalPageIds.indexOf(pageId);
  if(modalIndex<0){
    modalIndex=0;
  }
  showImageModalPage(modalIndex);
  imageModal.classList.add('active');
}
function showImageModalPage(idx){
  if(idx<0||idx>=modalPageIds.length) return;
  let pid=modalPageIds[idx];
  if(pid.startsWith('pdf-')){
    // éœ€è¦ç¦»å±æ¸²æŸ“(å¤§å›¾)
    let pNum=parseInt(pid.replace('pdf-',''));
    renderPDFPageToDataURL(pNum,1.0).then(url=>{
      imageModalImg.src=url;
    });
  } else {
    let imgObj=appState.imagePages.find(x=>x.id===pid);
    if(imgObj){
      imageModalImg.src=imgObj.dataURL;
    }
  }
}
async function renderPDFPageToDataURL(pageNum, scale){
  if(!appState.pdfDoc) return '';
  let page=await appState.pdfDoc.getPage(pageNum);
  let vp=page.getViewport({scale});
  let c=document.createElement('canvas');
  c.width=vp.width; c.height=vp.height;
  await page.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
  return c.toDataURL('image/png');
}

function closeImageModal(){
  imageModal.classList.remove('active');
}
// å·¦å³
function gotoModalPrevPage(){
  modalIndex=Math.max(0, modalIndex-1);
  showImageModalPage(modalIndex);
}
function gotoModalNextPage(){
  modalIndex=Math.min(modalPageIds.length-1, modalIndex+1);
  showImageModalPage(modalIndex);
}

/* ================================================
 * 4. å¯¼å‡ºç³»ç»Ÿ
 * ================================================*/
function applyPreset(preset){
  if(preset==='web'){
    document.getElementById('dpiSelect').value='72';
    updateQuality(80);
  } else if(preset==='print'){
    document.getElementById('dpiSelect').value='300';
    updateQuality(100);
  }
}
function updateFormatOptions(){
  const fmt=document.getElementById('exportFormat').value;
  const imgOpt=document.getElementById('imageOptions');
  const pdfOpt=document.getElementById('pdfOptions');
  if(fmt==='png'||fmt==='jpg'){
    imgOpt.style.display='block';
    pdfOpt.style.display='none';
  } else {
    imgOpt.style.display='none';
    pdfOpt.style.display='block';
  }
}
function updateQuality(val){
  appState.exportSettings.quality=parseInt(val)/100;
  document.getElementById('qualityValue').innerText=val;
}
function startExport(){
  if(!appState.pdfDoc && !appState.imagePages.length){
    showError('è¯·å…ˆåŠ è½½PDFæˆ–å¯¼å…¥å›¾ç‰‡åºåˆ—');
    return;
  }
  showLoading('æ­£åœ¨å¯¼å‡º...');
  appState.exportSettings.format=document.getElementById('exportFormat').value;
  appState.exportSettings.dpi=parseInt(document.getElementById('dpiSelect').value,10);
  appState.exportSettings.pdfVersion=document.getElementById('pdfVersion').value;
  appState.exportSettings.compress=document.getElementById('compressPDF').checked;

  let fmt=appState.exportSettings.format;
  if(fmt==='png'||fmt==='jpg'){
    exportGroupedImages(fmt).then(()=>{
      hideLoading();
      showToast('å¯¼å‡ºå®Œæˆï¼','success');
    }).catch(err=>{
      hideLoading();
      showError('å¯¼å‡ºå¤±è´¥:'+err);
    });
  } else if(fmt==='pdf-single'){
    exportGroupedPDFSingle().then(()=>{
      hideLoading();
    }).catch(err=>{
      hideLoading();
      showError('å¯¼å‡ºå¤±è´¥:'+err);
    });
  } else {
    exportGroupedPDFMulti().then(()=>{
      hideLoading();
    }).catch(err=>{
      hideLoading();
      showError('å¯¼å‡ºå¤±è´¥:'+err);
    });
  }
}

// color->(æ’å¥½åºçš„pageId[])
function getMultiColorGroups(){
  let groupMap={};
  // å…ˆç»Ÿè®¡
  for(let pid in appState.pageColors){
    let cset=appState.pageColors[pid];
    if(cset&&cset.size>0){
      for(let c of cset){
        if(!groupMap[c]) groupMap[c]=[];
        groupMap[c].push(pid);
      }
    }
  }
  // åº”ç”¨ç”¨æˆ·è‡ªå®šä¹‰é¡ºåº(è‹¥æœ‰)
  // å¦åˆ™æŒ‰ mainPageOrder ä¸­çš„å…ˆå
  let mainList = appState.mainPageOrder.map(x=>x.type==='pdf'?`pdf-${x.pageNum}`:x.id);
  for(let c in groupMap){
    // å¦‚æœ customPageOrder[c] å­˜åœ¨ï¼Œåˆ™ä¼˜å…ˆ
    if(appState.customPageOrder[c]){
      // ä»…ä¿ç•™åŸæœ‰çš„pid
      let newArr=appState.customPageOrder[c].filter(pid=>groupMap[c].includes(pid));
      groupMap[c]=newArr;
    } else {
      // å¦åˆ™æŒ‰ç…§ mainList é¡ºåºè¿‡æ»¤
      let newArr=[];
      for(let pid of mainList){
        if(groupMap[c].includes(pid)){
          newArr.push(pid);
        }
      }
      groupMap[c]=newArr;
    }
  }
  return groupMap;
}

/* ========== å¯¼å‡ºä¸ºå›¾åƒ ========== */
async function exportGroupedImages(fmt){
  const groups=getMultiColorGroups();
  const colorList=appState.groupOrder.filter(c=>groups[c]&&groups[c].length>0);
  if(colorList.length===0){
    showToast('æ²¡æœ‰ä»»ä½•å¯å¯¼å‡ºçš„åˆ†ç»„','error');
    return;
  }
  let idx=0;
  for(let color of colorList){
    idx++;
    let pages=groups[color];
    let cList=[];
    for(let pid of pages){
      let cvs=await renderPageOffscreen(pid, appState.exportSettings.dpi);
      if(cvs) cList.push(cvs);
    }
    if(!cList.length) continue;
    let bigBlob=await mergeCanvasesToLongImage(cList,fmt);
    let name=appState.groupNames[color]||`group_${idx}`;
    downloadBlob(bigBlob,`${name}.${fmt}`);
  }
}
/* ç¦»å±æ¸²æŸ“(æ”¯æŒpdf-xxx / img-xxx) */
async function renderPageOffscreen(pageId,dpi){
  if(pageId.startsWith('pdf-')){
    let pNum=parseInt(pageId.replace('pdf-',''));
    if(!appState.pdfDoc) return null;
    let page=await appState.pdfDoc.getPage(pNum);
    let scale=dpi/72;
    let vp=page.getViewport({scale});
    let cv=document.createElement('canvas');
    cv.width=vp.width; cv.height=vp.height;
    await page.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise;
    return cv;
  } else {
    // image
    let imgObj=appState.imagePages.find(x=>x.id===pageId);
    if(!imgObj) return null;
    // è¦æ”¾å¤§/ç¼©å°ï¼Ÿ è¿™é‡Œç®€å•ï¼šä¸ç¼©æ”¾
    let imageData=new Image();
    imageData.src=imgObj.dataURL;
    await new Promise(res=>{
      imageData.onload=res;
      imageData.onerror=res;
    });
    // ç”Ÿæˆç¦»å±canvas
    let cv=document.createElement('canvas');
    cv.width=imageData.width; 
    cv.height=imageData.height;
    let ctx=cv.getContext('2d');
    ctx.drawImage(imageData,0,0);
    return cv;
  }
}
// æ‹¼æˆé•¿å›¾
async function mergeCanvasesToLongImage(cvList,fmt){
  let tw=0,th=0;
  for(let c of cvList){
    if(c.width>tw) tw=c.width;
    th+=c.height;
  }
  let merged=document.createElement('canvas');
  merged.width=tw; merged.height=th;
  let ctx=merged.getContext('2d');
  let y=0;
  for(let c of cvList){
    ctx.drawImage(c,0,y);
    y+=c.height;
  }
  let mime=(fmt==='jpg')?'image/jpeg':'image/png';
  let q=(fmt==='jpg')?appState.exportSettings.quality:1.0;
  return new Promise(res=>{
    merged.toBlob(b=>res(b),mime,q);
  });
}

/* ========== å¯¼å‡ºPDF(å•æ–‡ä»¶) ========== */
async function exportGroupedPDFSingle(){
  const groups=getMultiColorGroups();
  const colorList=appState.groupOrder.filter(c=>groups[c]&&groups[c].length>0);
  if(!colorList.length){
    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„åˆ†ç»„','error');
    return;
  }
  const pdfLib=window.PDFLib;
  const outPdf=await pdfLib.PDFDocument.create();

  let idx=0;
  for(let color of colorList){
    idx++;
    let pages=groups[color];
    if(!pages.length) continue;
    let cList=[];
    for(let pid of pages){
      let c=await renderPageOffscreen(pid,appState.exportSettings.dpi);
      if(c) cList.push(c);
    }
    if(!cList.length) continue;
    let bigCv=await mergeCanvasDom(cList);
    let img=bigCv.toDataURL('image/png');
    let emb=await outPdf.embedPng(img);
    let page=outPdf.addPage([bigCv.width,bigCv.height]);
    page.drawImage(emb,{x:0,y:0,width:bigCv.width,height:bigCv.height});
  }
  let opt={};
  if(appState.exportSettings.pdfVersion==='1.4'){
    opt.useObjectStreams=false;
  }
  let bytes=await outPdf.save(opt);
  downloadBlob(new Blob([bytes],{type:'application/pdf'}),"grouped_single.pdf");
  showToast(`å·²å¯¼å‡º${colorList.length}ç»„åˆ°å•ä¸ªPDF!`,'success');
}
async function mergeCanvasDom(cList){
  let w=0,h=0;
  for(let c of cList){
    w=Math.max(w,c.width);
    h+=c.height;
  }
  let mc=document.createElement('canvas');
  mc.width=w; mc.height=h;
  let ctx=mc.getContext('2d');
  let y=0;
  for(let c of cList){
    ctx.drawImage(c,0,y);
    y+=c.height;
  }
  return mc;
}

/* ========== å¯¼å‡ºPDF(å¤šæ–‡ä»¶) ========== */
async function exportGroupedPDFMulti(){
  const groups=getMultiColorGroups();
  const colorList=appState.groupOrder.filter(c=>groups[c]&&groups[c].length>0);
  if(!colorList.length){
    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„åˆ†ç»„','error');
    return;
  }
  const pdfLib=window.PDFLib;

  let idx=0;
  for(let color of colorList){
    idx++;
    let pages=groups[color];
    if(!pages.length) continue;
    let pdfDoc=await pdfLib.PDFDocument.create();
    let cList=[];
    for(let pid of pages){
      let cc=await renderPageOffscreen(pid,appState.exportSettings.dpi);
      if(cc) cList.push(cc);
    }
    if(!cList.length) continue;
    let bigCv=await mergeCanvasDom(cList);
    let img=bigCv.toDataURL('image/png');
    let emb=await pdfDoc.embedPng(img);
    let page=pdfDoc.addPage([bigCv.width,bigCv.height]);
    page.drawImage(emb,{x:0,y:0,width:bigCv.width,height:bigCv.height});

    let opt={};
    if(appState.exportSettings.pdfVersion==='1.4'){
      opt.useObjectStreams=false;
    }
    let bytes=await pdfDoc.save(opt);
    let name=appState.groupNames[color]||`group_${idx}`;
    downloadBlob(new Blob([bytes],{type:'application/pdf'}),`${name}.pdf`);
  }
  showToast('å·²å¯¼å‡ºå¤šä¸ªPDFæ–‡ä»¶ï¼','success');
}


/* ================================================
 * 5. é€šç”¨å·¥å…· + Toast
 * ================================================*/
function downloadBlob(blob,filename){
  let url=URL.createObjectURL(blob);
  let a=document.createElement('a');
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
function updateProgress(percent){
  let pb=document.getElementById('globalProgress');
  pb.style.width=Math.min(100,percent)+'%';
}
function showLoading(msg){
  updateProgress(0);
  showToast(msg,'info');
}
function hideLoading(){
  updateProgress(0);
  hideToast();
}

let toastTimer=null, isMouseOverToast=false;
function showToast(message,typeOrColor='info'){
  let t=document.getElementById('toast');
  let tm=document.getElementById('toastMessage');
  tm.textContent=message;
  t.classList.remove('slide-out');
  t.classList.add('show');
  t.style.transform='translateX(0)';
  t.style.opacity='1';

  if(typeof typeOrColor==='string' && typeOrColor.startsWith('#')){
    t.style.borderLeftColor=typeOrColor;
  } else {
    t.style.borderLeftColor='transparent';
  }
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{
    if(!isMouseOverToast){
      hideToastSlide();
    }
  },3000);
}
function hideToastSlide(){
  let t=document.getElementById('toast');
  t.classList.add('slide-out');
  toastTimer=setTimeout(()=>{
    t.classList.remove('show','slide-out');
  },400);
}
function hideToast(){
  if(toastTimer) clearTimeout(toastTimer);
  let t=document.getElementById('toast');
  t.classList.remove('show','slide-out');
}
function showError(msg){
  hideLoading();
  showToast(msg,'#ef4444');
}
const toastEl=document.getElementById('toast');
toastEl.addEventListener('mouseenter',()=>{
  isMouseOverToast=true;
  if(toastEl.classList.contains('slide-out')){
    toastEl.classList.remove('slide-out');
    toastEl.style.transform='translateX(0)';
    toastEl.style.opacity='1';
  }
});
toastEl.addEventListener('mouseleave',()=>{
  isMouseOverToast=false;
  toastTimer=setTimeout(()=>{
    if(!isMouseOverToast){
      hideToastSlide();
    }
  },3000);
});


/* ================================================
 * 6. å³ä¾§åˆå¹¶é¢„è§ˆ & åˆ†ç»„ç®¡ç†
 * ================================================*/
const mergedPreviewArea=document.getElementById('mergedPreviewArea');

function updateMergedPreview(){
  mergedPreviewArea.querySelectorAll('.group-preview').forEach(x=>x.remove());
  let groups=getMultiColorGroups();
  let idx=0;
  for(let color of appState.groupOrder){
    let pages=groups[color];
    if(!pages||!pages.length) continue;
    idx++;

    let groupDiv=document.createElement('div');
    groupDiv.className='group-preview';
    groupDiv.dataset.color=color;
    groupDiv.draggable=true;

    // åˆ†ç»„æ‹–æ‹½
    groupDiv.addEventListener('dragstart',groupDragStart);
    groupDiv.addEventListener('dragend',groupDragEnd);
    groupDiv.addEventListener('dragover',groupDragOver);
    groupDiv.addEventListener('drop',groupDrop);

    let header=document.createElement('div');
    header.className='group-header';

    let cbox=document.createElement('div');
    cbox.className='group-color-box';
    cbox.style.backgroundColor=color;
    header.appendChild(cbox);

    let inp=document.createElement('input');
    inp.className='group-title-input';
    inp.placeholder=`åˆ†ç»„${idx}`;
    if(appState.groupNames[color]){
      inp.value=appState.groupNames[color];
    }
    inp.onchange=(ev)=>{
      appState.groupNames[color]=ev.target.value;
    };
    header.appendChild(inp);

    let fsBtn=document.createElement('button');
    fsBtn.className='group-fullscreen-btn';
    fsBtn.textContent='å…¨å±é¢„è§ˆ';
    fsBtn.onclick=()=>openFullscreenPreview(color);
    header.appendChild(fsBtn);

    groupDiv.appendChild(header);

    let removeBtn=document.createElement('button');
    removeBtn.className='group-remove-btn';
    removeBtn.textContent='X';
    removeBtn.onclick=()=>removeGroup(color,groupDiv);
    groupDiv.appendChild(removeBtn);

    // åˆå¹¶åå°ç¼©ç•¥å›¾
    let mergedImg=document.createElement('img');
    mergedImg.className='group-merged-preview-img';
    groupDiv.appendChild(mergedImg);

    // é¡µç 
    let label=document.createElement('div');
    label.className='group-pages';
    label.textContent='é¡µç ï¼š'+pagesToRangeString(pages);
    groupDiv.appendChild(label);

    let scrollWrap=document.createElement('div');
    scrollWrap.className='preview-scroll';
    groupDiv.appendChild(scrollWrap);

    (async()=>{
      // å°é¡µç¼©ç•¥
      for(let pid of pages){
        let thumb=document.createElement('div');
        thumb.className='page-thumb';
        thumb.dataset.pageid=pid;
        thumb.draggable=true;

        thumb.addEventListener('dragstart',pageThumbDragStart);
        thumb.addEventListener('dragend',pageThumbDragEnd);
        thumb.addEventListener('dragover',pageThumbDragOver);
        thumb.addEventListener('drop',pageThumbDrop);

        let cv=await renderPageOffscreen(pid,36);
        if(cv){
          let im=document.createElement('img');
          im.src=cv.toDataURL('image/png');
          thumb.appendChild(im);
          // å¦‚æœå¤„äºæŸ¥çœ‹é¢„è§ˆæ¨¡å¼ => ç‚¹å‡»çœ‹å¤§å›¾
          thumb.onclick=()=>{
            if(appState.viewMode){
              openImageModal(pid,pages);
            }
          };
        }
        scrollWrap.appendChild(thumb);
      }
      // åˆå¹¶å›¾(å°dpi=24)
      let cList=[];
      for(let pid of pages){
        let cc=await renderPageOffscreen(pid,24);
        if(cc) cList.push(cc);
      }
      if(cList.length>0){
        let blob=await mergeCanvasesToLongImage(cList,'png');
        mergedImg.src=URL.createObjectURL(blob);
      }
    })();

    mergedPreviewArea.appendChild(groupDiv);
  }
}
function removeGroup(color,div){
  if(!confirm(`ç¡®å®šåˆ é™¤æ­¤åˆ†ç»„(${color})? è¿™ä¼šæ“¦é™¤å¯¹åº”é¡µé¢çš„é¢œè‰²æ ‡è®°ã€‚`))return;
  // æ¸…é™¤
  for(let pid in appState.pageColors){
    if(appState.pageColors[pid].has(color)){
      appState.pageColors[pid].delete(color);
      // åŒæ­¥ä¸­é—´é¢„è§ˆè¾¹æ¡†
      const cont=previewArea.querySelector(`.page-container[data-pageid='${pid}']`);
      if(cont) updatePageContainerBorder(cont,pid);
    }
  }
  let idx=appState.groupOrder.indexOf(color);
  if(idx>=0) appState.groupOrder.splice(idx,1);
  delete appState.groupNames[color];
  delete appState.customPageOrder[color];
  // é¢œè‰²é¢æ¿ç§»é™¤
  let items=[...colorPalette.querySelectorAll('.color-item')];
  for(let it of items){
    if(it.style.backgroundColor.toLowerCase()===color.toLowerCase()){
      it.remove();
    }
  }
  div.remove();
  updateMergedPreview();
}

// åˆ†ç»„æ‹–æ‹½
let draggedGroup=null;
function groupDragStart(e){
  e.currentTarget.classList.add('dragging');
  draggedGroup=e.currentTarget;
}
function groupDragEnd(e){
  e.currentTarget.classList.remove('dragging');
  draggedGroup=null;
  saveGroupOrderFromDOM();
}
function groupDragOver(e){
  e.preventDefault();
  let tgt=e.currentTarget;
  if(tgt!==draggedGroup){
    tgt.classList.add('droptarget-hover');
  }
}
function groupDrop(e){
  e.preventDefault();
  let tgt=e.currentTarget;
  tgt.classList.remove('droptarget-hover');
  if(draggedGroup&&draggedGroup!==tgt){
    let container=tgt.parentElement;
    let arr=[...container.querySelectorAll('.group-preview')];
    let drI=arr.indexOf(draggedGroup);
    let tgI=arr.indexOf(tgt);
    if(drI<tgI){
      container.insertBefore(draggedGroup,tgt.nextSibling);
    } else {
      container.insertBefore(draggedGroup,tgt);
    }
  }
}
function saveGroupOrderFromDOM(){
  let arr=[...mergedPreviewArea.querySelectorAll('.group-preview')];
  appState.groupOrder=arr.map(x=>x.dataset.color);
}

/* ç¼©ç•¥å›¾(åˆ†ç»„å†…éƒ¨)æ‹–æ‹½ */
let draggedThumb=null;
function pageThumbDragStart(e){
  draggedThumb=e.currentTarget;
  draggedThumb.classList.add('dragging');
}
function pageThumbDragEnd(e){
  if(draggedThumb){
    draggedThumb.classList.remove('dragging');
    draggedThumb=null;
  }
  let gp=e.currentTarget.closest('.group-preview');
  if(gp) updateGroupPagesOrder(gp);
}
function pageThumbDragOver(e){
  e.preventDefault();
  let tgt=e.currentTarget;
  if(tgt!==draggedThumb){
    tgt.classList.add('droptarget-hover');
  }
}
function pageThumbDrop(e){
  e.preventDefault();
  let tgt=e.currentTarget;
  tgt.classList.remove('droptarget-hover');
  if(draggedThumb&&draggedThumb!==tgt){
    let container=tgt.parentElement;
    let arr=[...container.querySelectorAll('.page-thumb')];
    let drI=arr.indexOf(draggedThumb);
    let tgI=arr.indexOf(tgt);
    if(drI<tgI){
      container.insertBefore(draggedThumb,tgt.nextSibling);
    } else {
      container.insertBefore(draggedThumb,tgt);
    }
  }
}
function updateGroupPagesOrder(groupDiv){
  let color=groupDiv.dataset.color;
  let thumbs=[...groupDiv.querySelectorAll('.page-thumb')];
  let newPages=thumbs.map(t=>t.dataset.pageid);
  // æ›´æ–° customPageOrder[color]
  appState.customPageOrder[color]=newPages;
  // æ›´æ–° 'é¡µç :...'
  let label=groupDiv.querySelector('.group-pages');
  if(label){
    label.textContent='é¡µç ï¼š'+pagesToRangeString(newPages);
  }
  // é‡æ–°åˆå¹¶ç¼©ç•¥å›¾
  let mergedImg=groupDiv.querySelector('.group-merged-preview-img');
  if(!mergedImg)return;
  (async()=>{
    let cList=[];
    for(let pid of newPages){
      let cc=await renderPageOffscreen(pid,24);
      if(cc) cList.push(cc);
    }
    if(cList.length>0){
      let blob=await mergeCanvasesToLongImage(cList,'png');
      mergedImg.src=URL.createObjectURL(blob);
    } else {
      mergedImg.src='';
    }
  })();
}


/* ä¸€é”®é‡æ’ */
function reorderGroupNames(){
  let idx=1;
  for(let c of appState.groupOrder){
    appState.groupNames[c]=`åˆ†ç»„${idx}`;
    idx++;
  }
  updateMergedPreview();
}
/* æ¸…ç©ºåˆ†ç»„ */
function clearAllGroups(){
  if(!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åˆ†ç»„(é¢œè‰²)å—ï¼Ÿ\nè¿™ä¼šç§»é™¤æ‰€æœ‰æ ‡è®°ï¼'))return;
  for(let pid in appState.pageColors){
    appState.pageColors[pid].clear();
  }
  appState.groupOrder=[];
  appState.groupNames={};
  appState.customPageOrder={};
  // åŒæ—¶æ›´æ–°ä¸­é—´é¢„è§ˆ
  let allC=[...previewArea.querySelectorAll('.page-container')];
  for(let c of allC){
    c.style.borderColor='transparent';
  }
  // æ¸…ç©ºè°ƒè‰²æ¿
  let items=[...colorPalette.querySelectorAll('.color-item')];
  for(let it of items) it.remove();
  initDefaultColors();
  updateMergedPreview();
  showToast('å·²æ¸…ç©ºæ‰€æœ‰åˆ†ç»„','info');
}

/* ç”Ÿæˆç±»ä¼¼ "pdf-1,pdf-2,pdf-3" => "1-3" ï¼›"img-001,img-002" => "1-2"? 
 * è¿™é‡Œç®€å•åšï¼šåªè§£æpdf-x => x, å…¶ä½™åˆå¹¶æˆ"?". 
 * ä½ ä¹Ÿå¯è¿›ä¸€æ­¥æŠŠimg-xxxå½“ä½œæ•°å­—xxx.
 */
function pagesToRangeString(pidArr){
  if(!pidArr||!pidArr.length)return '';
  let nums=[];
  for(let p of pidArr){
    if(p.startsWith('pdf-')){
      let n=parseInt(p.replace('pdf-',''));
      nums.push(n);
    } else {
      // è§£æimg
      let id=p.replace('img-','');
      let n=parseInt(id,10);
      if(!isNaN(n)) nums.push(n);
      else nums.push('?');
    }
  }
  // æ’åº
  nums.sort((a,b)=>(a-b));
  // åˆ†æ®µ
  let res=[];
  let start=nums[0], prev=nums[0];
  for(let i=1;i<nums.length;i++){
    let cur=nums[i];
    if(typeof cur==='number'&&typeof prev==='number'&&cur===prev+1){
      prev=cur;
    } else {
      if(start===prev) res.push(String(start));
      else res.push(`${start}-${prev}`);
      start=cur;
      prev=cur;
    }
  }
  if(start===prev) res.push(String(start));
  else res.push(`${start}-${prev}`);
  return res.join(',');
}


/* ================================================
 * 7. åˆ†ç»„å…¨å±é¢„è§ˆ
 * ================================================*/
const fullscreenModal=document.getElementById('fullscreenModal');
const fsLeftPanel=document.getElementById('fsLeftPanel');
const fsPreviewImgs=document.getElementById('fsPreviewImgs');
let fsCurrentColor=null;
let fsCurrentPages=[];

function openFullscreenPreview(color){
  fsCurrentColor=color;
  const groups=getMultiColorGroups();
  fsCurrentPages=[...(groups[color]||[])];
  fullscreenModal.classList.add('active');
  document.getElementById('fsLeftTitle').textContent=`åˆ†ç»„é¢„è§ˆ: ${appState.groupNames[color]||color}`;
  refreshFsLeftPanel();
  refreshFsPreview();
}
function closeFullscreenModal(){
  saveFsPageOrder();
  fullscreenModal.classList.remove('active');
}
function refreshFsLeftPanel(){
  fsLeftPanel.querySelectorAll('.page-item').forEach(x=>x.remove());
  fsCurrentPages.forEach(pid=>{
    let item=document.createElement('div');
    item.className='page-item';
    item.dataset.pageid=pid;
    item.draggable=true;

    item.addEventListener('dragstart',ev=>ev.currentTarget.classList.add('dragging'));
    item.addEventListener('dragend',ev=>{
      ev.currentTarget.classList.remove('dragging');
      reorderFsPages();
    });
    item.addEventListener('dragover',ev=>{
      ev.preventDefault();
      if(ev.currentTarget!==item){
        ev.currentTarget.classList.add('droptarget-hover');
      }
    });
    item.addEventListener('dragleave',ev=>{
      ev.currentTarget.classList.remove('droptarget-hover');
    });
    item.addEventListener('drop',ev=>{
      ev.preventDefault();
      let draggingItem=fsLeftPanel.querySelector('.page-item.dragging');
      const t=ev.currentTarget;
      t.classList.remove('droptarget-hover');
      if(draggingItem && draggingItem!==t){
        let children=[...fsLeftPanel.querySelectorAll('.page-item')];
        let drI=children.indexOf(draggingItem);
        let tgI=children.indexOf(t);
        if(drI<tgI){
          fsLeftPanel.insertBefore(draggingItem,t.nextSibling);
        } else {
          fsLeftPanel.insertBefore(draggingItem,t);
        }
      }
    });

    // æ˜¾ç¤ºç¼©ç•¥
    let thumb=document.createElement('img');
    renderPageOffscreen(pid,24).then(cv=>{
      if(cv){
        thumb.src=cv.toDataURL('image/png');
      } else{
        thumb.src='';
      }
    });
    item.appendChild(thumb);

    let sp=document.createElement('span');
    sp.textContent=pid;
    item.appendChild(sp);

    let delBtn=document.createElement('button');
    delBtn.className='delete-page-btn';
    delBtn.textContent='Ã—';
    delBtn.onclick=()=>{
      fsCurrentPages=fsCurrentPages.filter(x=>x!==pid);
      if(appState.pageColors[pid]?.has(fsCurrentColor)){
        appState.pageColors[pid].delete(fsCurrentColor);
        // æ›´æ–°ä¸­é—´é¢„è§ˆ
        let c=previewArea.querySelector(`.page-container[data-pageid='${pid}']`);
        if(c) updatePageContainerBorder(c,pid);
      }
      refreshFsLeftPanel();
      refreshFsPreview();
      updateMergedPreview();
    };
    item.appendChild(delBtn);

    fsLeftPanel.appendChild(item);
  });
}
function reorderFsPages(){
  let items=[...fsLeftPanel.querySelectorAll('.page-item')];
  fsCurrentPages=items.map(x=>x.dataset.pageid);
  refreshFsPreview();
}
async function refreshFsPreview(){
  fsPreviewImgs.innerHTML='';
  if(!fsCurrentPages.length){
    fsPreviewImgs.textContent='(æš‚æ— é¡µé¢)';
    return;
  }
  let cList=[];
  for(let pid of fsCurrentPages){
    let cc=await renderPageOffscreen(pid,72);
    if(cc) cList.push(cc);
  }
  let blob=await mergeCanvasesToLongImage(cList,'png');
  if(blob){
    let url=URL.createObjectURL(blob);
    let im=document.createElement('img');
    im.src=url;
    im.className='preview-large-img';
    fsPreviewImgs.appendChild(im);
  }
}
function sortFsPagesByNumber(){
  // ä»…å¯¹pdf-xçš„æ•°å­—+img-xçš„æ•°å­—åšç®€å•æ’åº
  fsCurrentPages.sort((a,b)=>{
    return parsePageIdNum(a)-parsePageIdNum(b);
  });
  refreshFsLeftPanel();
  refreshFsPreview();
}
function parsePageIdNum(pid){
  if(pid.startsWith('pdf-')){
    return parseInt(pid.replace('pdf-',''));
  } else if(pid.startsWith('img-')){
    return parseInt(pid.replace('img-',''));
  }
  return 999999;
}
function saveFsPageOrder(){
  appState.customPageOrder[fsCurrentColor]=[...fsCurrentPages];
  updateMergedPreview();
}

/* ================================================
 * 8. é¼ æ ‡å…‰æ ‡(é¢œè‰²ç‚¹/æ©¡çš®), å¹¶åœ¨â€œå¯¼å‡ºè®¾ç½®åŒºâ€å’Œâ€œåˆå¹¶é¢„è§ˆåŒºâ€ä¸­éšè—
 * ================================================*/
const cursorDot=document.getElementById('cursorDot');
document.addEventListener('mousemove',(e)=>{
  cursorDot.style.left=(e.clientX - cursorDot.offsetWidth/2)+'px';
  cursorDot.style.top=(e.clientY - cursorDot.offsetHeight/2)+'px';
});
function updateCursorDot(){
  if(appState.eraserMode){
    // æ©¡çš®(ç©ºå¿ƒ)
    cursorDot.style.border=`2px solid ${appState.currentColor}`;
    cursorDot.style.backgroundColor='transparent';
    cursorDot.style.width='24px'; cursorDot.style.height='24px';
  } else {
    // æ™®é€šé¢œè‰²
    cursorDot.style.border='none';
    cursorDot.style.backgroundColor=appState.currentColor;
    cursorDot.style.width='16px'; cursorDot.style.height='16px';
  }
}
cursorDot.style.display='block';
updateCursorDot();

/* å½“é¼ æ ‡ç§»å…¥â€œå¯¼å‡ºè®¾ç½®â€ æˆ– â€œåˆå¹¶é¢„è§ˆ & åˆ†ç»„ç®¡ç†â€æ—¶éšè—å…‰æ ‡ */
const exportSettingsArea=document.getElementById('exportSettingsArea');
exportSettingsArea.addEventListener('mouseenter',()=>cursorDot.style.display='none');
exportSettingsArea.addEventListener('mouseleave',()=>{
  cursorDot.style.display='block';
  updateCursorDot();
});
const mergedArea=document.getElementById('mergedPreviewArea');
mergedArea.addEventListener('mouseenter',()=>cursorDot.style.display='none');
mergedArea.addEventListener('mouseleave',()=>{
  cursorDot.style.display='block';
  updateCursorDot();
});

/* åˆå§‹åŒ–UI */
updateFormatOptions();
</script>
</body>
</html>
